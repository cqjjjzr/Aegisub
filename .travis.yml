sudo: required
dist: bionic
language: python # To use conan
python: "3.7"
compiler:
  - gcc

cache:
  directories:
  - ~/.conan

git:
  submodules: false

addons:
  apt:
    sources:
      - sourceline: 'deb https://apt.kitware.com/ubuntu/ bionic main'
        key_url: 'https://apt.kitware.com/keys/kitware-archive-latest.asc'
    packages:
    - libasound2-dev
    - luarocks
    - cmake
    - build-essential
    - autopoint

matrix:
  include:
  - {}

install:
- sudo luarocks install busted > /dev/null
- sudo luarocks install moonscript > /dev/null
- sudo luarocks install uuid > /dev/null
# Remove the CMake provided by travis
- sudo rm -rf /usr/local/cmake*
- pip install conan
- conan user
- git clone https://github.com/cqjjjzr/Aegisub-Conan-CMake.git

script:
- cd tests
- ./setup.sh
- cd ..
- mkdir build-dir
- cd build-dir
- cmake -DCMAKE_CXX_FLAGS='-Wall -Wextra -Wno-unused-parameter -pedantic' -DCMAKE_BUILD_TYPE='Release' -DCMAKE_C_FLAGS='-Wall' -DWITH_STARTUPLOG=ON -DWITH_CSRI=OFF -DWITH_TEST=ON -DDEPENDENCIES_CMAKE_FILE="./Aegisub-Conan-CMake/dependencies_conan.cmake" ..
- make -j2
- make test-aegisub -j2
- ctest --output-on-failure .

notifications:
  email:
  - on_success: change
  - on_failure: change

